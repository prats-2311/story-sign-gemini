This detailed implementation plan for **StorySign Reconnect** is designed to transform the current technical "tunnel" into a high-performance, autonomous "Therapist Agent". By completing these steps today, you will establish a robust architectural blueprint that can be seamlessly extended to the **Harmony** and **ASL** modules tomorrow.

---

### Phase 1: Backend Refactor – The "Observer" Nervous System

The goal is to move from a mechanical timer to a "Silence Protocol" where Gemini decides when to speak.

1. **Remove Manual Triggers**:
* In `backend/main.py`, delete the `pose_frame_count` logic and the `should_speak` variable.
* Remove the hardcoded `await session.send(input="Briefly check my form.", end_of_turn=True)` call.


2. **Implement the Silence Protocol**:
* Modify the pose data loop to send every optimized packet with `end_of_turn=True`.
* This signals to the Gemini Live API that it *can* respond to every data packet, but it will rely on the System Instruction to decide if it *should*.


3. **Standardize Data Headers**:
* Update the parsing logic in `receive_from_client` to handle a generalized `[DATA_TYPE]` format.
* This ensures the backend can route `[POSE_DATA]` (Reconnect/ASL) and `[FACE_DATA]` (Harmony) using the same logic.



### Phase 2: Frontend Refactor – The "Reflex" Dispatcher

We will upgrade the frontend to handle structured data, enabling real-time UI updates without cluttering the chat logs.

1. **Build the JSON Dispatcher**:
* In `src/hooks/useGeminiLive.ts`, update the `onmessage` handler to attempt a `JSON.parse` on every `msg.text` received from Gemini.
* **Logic**: If the message contains `"event_type": "correction"`, dispatch the data to a new `onCorrection` callback instead of adding it to the `messages` state.


2. **Implement "Optimistic UI" Cues**:
* Add a simple "Data Transmission" indicator in `App.tsx` that flickers when `[POSE_DATA]` is successfully sent.
* This provides the user with immediate visual confirmation that the "Observer" is watching, even when the model is silent.


3. **Frequency Tuning**:
* Adjust the `videoIntervalRef` in `useGeminiLive.ts` to send skeletal landmarks at 5–10 FPS while keeping the raw Video Frame at 1 FPS.
* This prioritizes the high-fidelity "logic" data for the model's math calculations .





### Phase 3: Prompt Engineering – The "Clinical" Brain

Refine the `RECONNECT_SYSTEM_INSTRUCTION` to support autonomous decision-making.

1. **The "Silence" Mandate**:
* Explicitly instruct the model: *"You are an autonomous therapist. Do not acknowledge every data packet. Speak only to count a valid repetition or to provide a specific, gentle form correction"*.


2. **Vector-Math Precision**:
* Reinforce the instructions for calculating specific joint angles (e.g., Elbow or Wrist angles) using the incoming coordinates .


* Ensure the model uses the `"event_type": "correction"` JSON schema for all feedback.


3. **Safety First**:
* Add a "Safety Override" clause: *"If you detect jerky movements or signs of pain (via video), stop the session immediately and provide supportive audio feedback"* .





### Phase 4: Persistence – The "Memory" Bridge

Prepare the "Deep Think" functionality to connect with the long-term therapist records.

1. **Session Logging**:
* In `backend/main.py`, update the `/analyze_session` endpoint to prepare a JSON object for TiDB.
* The object should include the `transcript`, the `pose_summary`, and the final Markdown report generated by `gemini-3-flash-preview`.


2. **Schema Alignment**:
* Ensure the performance data (angles, symmetry scores) captured during the Live session is formatted to match the `patient_exercise_log` table schema .





### Phase 5: Performance & Deployment

Ensuring the "Agentic Partner" feels instantaneous during the hackathon demo.

1. **Google Cloud Deployment**:
* Deploy the backend via **Cloud Run** in `us-central1` to minimize latency to the Gemini Live API.
* Enable **Session Affinity** to keep the WebSocket connection stable throughout the therapy session.


2. **Final Demo Loop (Reconnect)**:
* **Start**: Patient selects "Elbow Flexion" exercise.
* **Action**: Patient performs 5 reps.
* **Observer**: Gemini counts "1... 2... keep your back straight... 3...".
* **Finish**: Patient clicks "Deep Think Analyze" to receive their professional progress report.



